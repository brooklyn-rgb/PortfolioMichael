@using System.Text.Json
@inject IConfiguration Configuration

<!-- Chatbot Widget -->
<div id="chatbot-container" class="chatbot-container">
    <!-- Chatbot Button -->
    <button id="chatbot-toggle" class="chatbot-toggle" aria-label="Open chatbot">
        <i class="bi bi-robot"></i>
        <span class="chatbot-pulse"></span>
        <span class="chatbot-notification" id="chatbot-notification">1</span>
    </button>

    <!-- Chatbot Window -->
    <div id="chatbot-window" class="chatbot-window">
        <!-- Chat Header -->
        <div class="chatbot-header">
            <div class="chatbot-header-content">
                <div class="chatbot-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="chatbot-info text-success">
                    <h3>Hi Am Michael Assistant</h3>
                    <p>Ask me!</p>
                </div>
                <button id="chatbot-close" class="chatbot-close" aria-label="Close chatbot">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatbot-messages" class="chatbot-messages">
            <!-- Welcome message will be added here -->
        </div>

        <!-- Chat Input -->
        <div class="chatbot-input">
            <div class="input-group">
                <input type="text"
                       id="chatbot-input"
                       class="form-control"
                       placeholder="Type your message here..."
                       aria-label="Message input"
                       autocomplete="off">
                <button id="chatbot-send" class="btn btn-send" aria-label="Send message">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
            <div class="quick-actions">
                <button class="quick-action" data-question="Tell me about your ASP.NET experience">
                    <i class="bi bi-code-slash"></i> ASP.NET Experience
                </button>
                <button class="quick-action" data-question="What are your core skills?">
                    <i class="bi bi-gear-fill"></i> Core Skills
                </button>
                <button class="quick-action" data-question="Are you available for work?">
                    <i class="bi bi-calendar-check"></i> Availability
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* Chatbot Container */
    .chatbot-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Chatbot Toggle Button */
    .chatbot-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border: none;
        color: slategrey;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4), 0 5px 15px rgba(16, 185, 129, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10000;
    }

        .chatbot-toggle:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5), 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .chatbot-toggle:active {
            transform: scale(0.95);
        }

    .chatbot-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--primary);
        animation: pulse 2s infinite;
        z-index: -1;
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

    .chatbot-notification {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: white;
        font-size: 12px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        animation: bounce 2s infinite;
    }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }

    /* Chatbot Window */
    .chatbot-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 380px;
        height: 550px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 10px 30px rgba(16, 185, 129, 0.1);
        display: none;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
    }

        .chatbot-window.active {
            display: flex;
            transform: translateY(0);
            opacity: 1;
            animation: slideUp 0.3s ease;
        }

    @@keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Chatbot Header */
    .chatbot-header {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        padding: 1.5rem;
    }

    .chatbot-header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chatbot-avatar {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        backdrop-filter: blur(10px);
    }

    .chatbot-info h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .chatbot-info p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .chatbot-close {
        margin-left: auto;
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.3s;
    }

        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

    /* Chat Messages */
    .chatbot-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 1rem;
        border-radius: 18px;
        line-height: 1.4;
        position: relative;
        animation: messageIn 0.3s ease;
    }

    @@keyframes messageIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.bot {
        background: white;
        color: var(--dark);
        border: 1px solid rgba(16, 185, 129, 0.2);
        align-self: flex-start;
        border-bottom-left-radius: 5px;
    }

    .message.user {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.5rem;
        text-align: right;
    }

    /* Chat Input */
    .chatbot-input {
        padding: 1.5rem;
        background: white;
        border-top: 1px solid rgba(16, 185, 129, 0.1);
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .form-control {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid rgba(16, 185, 129, 0.2);
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

    .btn-send {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 12px;
        padding: 0 1.2rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    .quick-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .quick-action {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        color: var(--primary-dark);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
    }

        .quick-action:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .quick-action i {
            font-size: 0.9rem;
        }

    /* Scrollbar Styling */
    .chatbot-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chatbot-messages::-webkit-scrollbar-track {
        background: rgba(16, 185, 129, 0.1);
        border-radius: 3px;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
        background: var(--success);
        border-radius: 3px;
    }

        .chatbot-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 0.3rem;
        padding: 1rem;
        background: white;
        border-radius: 18px;
        border: 1px solid rgba(16, 185, 129, 0.2);
        align-self: flex-start;
        max-width: 60px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

    @@keyframes typing {
        0%, 80%, 100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Message Actions */
    .message-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .message-action {
        background: none;
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: var(--primary);
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.3s;
    }

        .message-action:hover {
            background: rgba(16, 185, 129, 0.1);
        }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .chatbot-container {
            bottom: 20px;
            right: 20px;
        }

        .chatbot-toggle {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .chatbot-window {
            width: calc(100vw - 40px);
            right: 0;
            left: 0;
            margin: 0 auto;
            height: 70vh;
            bottom: 70px;
        }

        .chatbot-header {
            padding: 1rem;
        }

        .message {
            max-width: 90%;
        }
    }

    /* Dark Mode Support */
    @@media (prefers-color-scheme: dark) {
        .chatbot-window {
            background: var(--accent);
            color: midnightblue;
        }

        .chatbot-messages {
            background: #1a202c;
        }

        .message.bot {
            background: #2d3748;
            color: white;
            border-color: #4a5568;
        }

        .form-control {
            background: #2d3748;
            border-color: #4a5568;
            color: white;
        }

            .form-control:focus {
                border-color: var(--primary-light);
                background: #2d3748;
            }

        .quick-action {
            background: #2d3748;
            border-color: #4a5568;
            color: var(--primary-light);
        }

        .typing-indicator {
            background: #2d3748;
            border-color: #4a5568;
        }

        .typing-dot {
            background: var(--primary-light);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSend = document.getElementById('chatbot-send');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotNotification = document.getElementById('chatbot-notification');
        const quickActions = document.querySelectorAll('.quick-action');

        // Knowledge base for chatbot responses
        const knowledgeBase = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good afternoon'],
                responses: [
                    "Hello! I'm your ASP.NET assistant. How can I help you today?",
                    "Hi there! Ready to talk about .NET development?",
                    "Hey! I'm here to help with your ASP.NET questions."
                ]
            },
            experience: {
                patterns: ['experience', 'years', 'background', 'professional'],
                responses: [
                    "I have over 8 years of professional experience building secure, scalable web applications with ASP.NET Core and .NET 8.",
                    "With 8+ years in ASP.NET development, I specialize in enterprise-grade solutions and cloud-ready architecture.",
                    "My experience spans 8 years focusing on ASP.NET Core, backend systems, and scalable web applications."
                ]
            },
            skills: {
                patterns: ['skills', 'technologies', 'stack', 'expertise'],
                responses: [
                    "My core skills include:<br>• ASP.NET Core & .NET 8<br>• RESTful API Design<br>• Microsoft Azure<br>• SQL Server & EF Core<br>• Clean Architecture<br>• React & TypeScript",
                    "I specialize in:<br>• Backend Engineering with .NET<br>• Cloud-Native Development<br>• Database Design & Optimization<br>• Enterprise Architecture<br>• CI/CD Pipelines",
                    "Primary expertise:<br>• ASP.NET Web API<br>• Microservices Architecture<br>• Performance Optimization<br>• Security Best Practices<br>• DevOps Practices"
                ]
            },
            availability: {
                patterns: ['available', 'hire', 'contract', 'work', 'job'],
                responses: [
                    "I'm currently available immediately for ASP.NET contract or permanent roles. I accept 6-12 month contracts and can work onsite/hybrid in Johannesburg.",
                    "Yes, I'm available for new opportunities! I'm open to both contract and permanent ASP.NET developer roles.",
                    "I'm actively seeking ASP.NET development opportunities. Available for immediate start on contract or permanent basis."
                ]
            },
            projects: {
                patterns: ['projects', 'portfolio', 'work', 'showcase'],
                responses: [
                    "I've worked on various projects including:<br>• Enterprise E-commerce Platforms<br>• Real Estate Management Systems<br>• Corporate Business Portals<br>• Blockchain Supply Chain Applications",
                    "Recent projects include:<br>• .NET 8 E-commerce with React<br>• Azure-based Real Estate CRM<br>• Business CMS with Razor Pages<br>• Blockchain tracking systems",
                    "My portfolio showcases:<br>• Scalable Web Applications<br>• Cloud-Native Solutions<br>• API Development<br>• Full-Stack Implementations"
                ]
            },
            contact: {
                patterns: ['contact', 'email', 'phone', 'reach', 'get in touch'],
                responses: [
                    "You can contact me via:<br>📧 Email: skillopp05@gmail.com<br>📞 Phone: +27 69 262 9422<br>🔗 LinkedIn: linkedin.com/in/michael-m-joyous<br>🌐 Portfolio: macfish.co.za",
                    "Contact details:<br>• Email: skillopp05@gmail.com<br>• Phone: +27 69 262 9422<br>• LinkedIn: Michael Mujabi<br>• Location: Germiston, South Africa"
                ]
            },
            default: {
                responses: [
                    "I'm not sure about that. Could you rephrase your question about ASP.NET development?",
                    "I specialize in ASP.NET development questions. Could you ask about my experience, skills, or availability?",
                    "As an ASP.NET assistant, I can help with questions about .NET development, my experience, or how to contact me."
                ]
            }
        };

        // Initialize chatbot with welcome message
        function initChatbot() {
            addMessage('bot', getWelcomeMessage());
            hideNotification();
        }

        function getWelcomeMessage() {
            const hour = new Date().getHours();
            let greeting = "Hello";

            if (hour < 12) greeting = "Good morning";
            else if (hour < 18) greeting = "Good afternoon";
            else greeting = "Good evening";

            return `${greeting}! I'm your ASP.NET Assistant. I can help you learn about Michael's expertise in .NET development. Feel free to ask about:<br><br>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 0.5rem 0;">
                <span class="quick-action" style="margin: 0;" onclick="handleQuickAction('Tell me about your ASP.NET experience')">ASP.NET Experience</span>
                <span class="quick-action" style="margin: 0;" onclick="handleQuickAction('What are your core skills?')">Core Skills</span>
                <span class="quick-action" style="margin: 0;" onclick="handleQuickAction('Are you available for work?')">Availability</span>
                <span class="quick-action" style="margin: 0;" onclick="handleQuickAction('How can I contact you?')">Contact Info</span>
            </div>`;
        }

        // Add message to chat
        function addMessage(sender, text, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (isHtml) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }

            // Add timestamp
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = getCurrentTime();
            messageDiv.appendChild(timeDiv);

            chatbotMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Show typing indicator
        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatbotMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Get current time formatted
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        // Process user input
        function processUserInput(input) {
            if (!input.trim()) return;

            // Add user message
            addMessage('user', input);

            // Clear input
            chatbotInput.value = '';

            // Show typing indicator
            setTimeout(() => {
                showTyping();

                // Simulate thinking delay
                setTimeout(() => {
                    hideTyping();

                    // Get bot response
                    const response = getBotResponse(input);
                    addMessage('bot', response, true);
                }, 1000 + Math.random() * 1000);
            }, 300);
        }

        // Get bot response based on user input
        function getBotResponse(input) {
            const inputLower = input.toLowerCase().trim();

            // Check for exact matches first
            if (inputLower.includes('asp.net') || inputLower.includes('.net')) {
                if (inputLower.includes('experience') || inputLower.includes('years')) {
                    return getRandomResponse(knowledgeBase.experience.responses);
                }
                if (inputLower.includes('skill') || inputLower.includes('expertise')) {
                    return getRandomResponse(knowledgeBase.skills.responses);
                }
            }

            // Check patterns in knowledge base
            for (const [category, data] of Object.entries(knowledgeBase)) {
                if (category === 'default') continue;

                for (const pattern of data.patterns) {
                    if (inputLower.includes(pattern)) {
                        return getRandomResponse(data.responses);
                    }
                }
            }

            // Check for greeting
            if (knowledgeBase.greetings.patterns.some(pattern =>
                inputLower.includes(pattern) ||
                ['hello', 'hi', 'hey'].includes(inputLower))) {
                return getRandomResponse(knowledgeBase.greetings.responses);
            }

            // Default response
            return getRandomResponse(knowledgeBase.default.responses);
        }

        // Get random response from array
        function getRandomResponse(responses) {
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Handle quick actions
        function handleQuickAction(question) {
            chatbotInput.value = question;
            processUserInput(question);
        }

        // Toggle chatbot window
        function toggleChatbot() {
            chatbotWindow.classList.toggle('active');
            chatbotToggle.classList.toggle('active');

            if (chatbotWindow.classList.contains('active')) {
                hideNotification();
                chatbotInput.focus();
            }
        }

        // Hide notification
        function hideNotification() {
            chatbotNotification.style.display = 'none';
        }

        // Event listeners
        chatbotToggle.addEventListener('click', toggleChatbot);
        chatbotClose.addEventListener('click', toggleChatbot);

        chatbotSend.addEventListener('click', () => {
            processUserInput(chatbotInput.value);
        });

        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                processUserInput(chatbotInput.value);
            }
        });

        quickActions.forEach(action => {
            action.addEventListener('click', () => {
                const question = action.getAttribute('data-question');
                handleQuickAction(question);
            });
        });

        // Close chatbot when clicking outside
        document.addEventListener('click', (e) => {
            if (!chatbotContainer.contains(e.target) &&
                !chatbotToggle.contains(e.target) &&
                chatbotWindow.classList.contains('active')) {
                toggleChatbot();
            }
        });

        // Show notification after 5 seconds
        setTimeout(() => {
            if (!chatbotWindow.classList.contains('active')) {
                chatbotNotification.style.display = 'flex';
            }
        }, 5000);

        // Initialize chatbot
        initChatbot();

        // Make handleQuickAction globally available for inline onclick
        window.handleQuickAction = handleQuickAction;
    });
</script>